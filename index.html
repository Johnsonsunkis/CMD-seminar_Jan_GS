<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0QVLue4OuTPLoFIuDmhOSPJyFyN3pBpuipF2D7-HtBr_uKJqK8M3nTNvKILHWIZwdoQdLL4xmLK18/pub?gid=0&single=true&output=csv";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz33lIur7_vuRhl-NxiA2-03y6GRpzMkPiCaFx7WbRKUvHM4icDSr_eBeoKQRG3z4Lq/exec";

    let participants = [];
    let locallyCheckedIn = new Set(); 
    let locallyReverted = new Set(); 

    // Pings the Web App for the LIVE list of present IDs
    async function fastSync() {
        try {
            const response = await fetch(SCRIPT_URL + "?getLiveStatus=true");
            const presentIds = await response.json();
            document.getElementById('sync-status').innerText = "Live Sync: " + new Date().toLocaleTimeString();
            
            // Mark items green that are in the server list (and not recently reverted here)
            presentIds.forEach(id => {
                if (!locallyReverted.has(id)) {
                    updateRowUI(id, true);
                }
            });

            // If an ID is NOT in the server list but is green here, turn it back to grey (Sync Revert)
            participants.forEach(p => {
                if (!presentIds.includes(p.id) && !locallyCheckedIn.has(p.id)) {
                    updateRowUI(p.id, false);
                }
            });
        } catch (e) { 
            console.log("Sync pinging...");
        }
    }

    async function refreshData() {
        try {
            const response = await fetch(CSV_URL + "&cb=" + Date.now());
            const data = await response.text();
            const rows = data.split(/\r?\n/).filter(row => row.trim() !== "").slice(1); 
            
            const tbody = document.getElementById('table-body');
            let presentCount = 0;
            let html
