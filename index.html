<script>
    // 1. UPDATE THIS IF YOU CREATED A NEW SPREADSHEET
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0QVLue4OuTPLoFIuDmhOSPJyFyN3pBpuipF2D7-HtBr_uKJqK8M3nTNvKILHWIZwdoQdLL4xmLK18/pub?gid=0&single=true&output=csv";
    
    // 2. YOUR NEW ACCOUNT'S WEB APP URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3HUBmUFNy-g8wLiLNOLCXYbYyfn2Ly_0PitLedHpKZYX4aL2YtpmyYWy0BuRS_G2k5w/exec";

    let participants = [];
    let locallyCheckedIn = new Set(); 
    let locallyReverted = new Set(); 

    // Pings the NEW Web App for the LIVE list of present IDs
    async function fastSync() {
        try {
            const response = await fetch(SCRIPT_URL + "?getLiveStatus=true");
            const presentIds = await response.json();
            document.getElementById('sync-status').innerText = "Live Sync: " + new Date().toLocaleTimeString();
            
            // Mark items green that are in the server list
            presentIds.forEach(id => {
                if (!locallyReverted.has(id)) {
                    updateRowUI(id, true);
                }
            });

            // If an ID is NOT in the server list, turn it back to grey
            participants.forEach(p => {
                if (!presentIds.includes(p.id) && !locallyCheckedIn.has(p.id)) {
                    updateRowUI(p.id, false);
                }
            });
        } catch (e) { 
            console.log("Sync pinging...");
        }
    }

    async function refreshData() {
        try {
            const response = await fetch(CSV_URL + "&cb=" + Date.now());
            const data = await response.text();
            const rows = data.split(/\r?\n/).filter(row => row.trim() !== "").slice(1); 
            
            const tbody = document.getElementById('table-body');
            let presentCount = 0;
            let htmlContent = "";
            participants = [];

            rows.forEach(row => {
                const cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 3) return;

                const person = { id: cols[0], name: cols[1], combined: cols[2], status: cols[3] || "" };
                participants.push(person);

                const isPresentInSheet = person.status.toLowerCase() === "present";
                let showAsPresent = isPresentInSheet || locallyCheckedIn.has(person.id);
                if (locallyReverted.has(person.id)) showAsPresent = false;

                if (showAsPresent) presentCount++;

                htmlContent += `
                    <tr id="row-${person.id}" class="${showAsPresent ? 'row-present' : ''}">
                        <td>${person.id}</td>
                        <td>${person.name}</td>
                        <td>
                            <span class="badge" id="badge-${person.id}">${showAsPresent ? "IN" : "WAIT"}</span>
                            <button class="btn-revert" onclick="revertAttendance('${person.id}')">Undo</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = htmlContent;
            document.getElementById('count-display').innerText = presentCount;
        } catch (err) { console.error(err); }
    }

    function onScanSuccess(decodedText) {
        const scanResult = decodedText.trim();
        const person = participants.find(p => p.combined === scanResult);
        if (person) {
            // Update Last Scan Box
            const displayBox = document.getElementById('last-scan-display');
            const nameSpan = document.getElementById('last-person-name');
            if(displayBox) displayBox.style.display = "block";
            if(nameSpan) nameSpan.innerText = person.name + " (" + person.id + ")";

            if (locallyCheckedIn.has(person.id)) return;
            locallyReverted.delete(person.id);
            locallyCheckedIn.add(person.id);
            updateRowUI(person.id, true);
            
            fetch(`${SCRIPT_URL}?id=${person.id}&action=checkin`, { method: 'GET', mode: 'no-cors' });
            if (navigator.vibrate) navigator.vibrate(100);
        }
    }

    function revertAttendance(id) {
        if (!confirm("Undo attendance for ID: " + id + "?")) return;
        locallyCheckedIn.delete(id);
        locallyReverted.add(id);
        updateRowUI(id, false);
        fetch(`${SCRIPT_URL}?id=${id}&action=revert`, { method: 'GET', mode: 'no-cors' });
    }

    function updateRowUI(id, isPresent) {
        const row = document.getElementById("row-" + id);
        const badge = document.getElementById("badge-" + id);
        if (row) row.className = isPresent ? "row-present" : "";
        if (badge) badge.innerText = isPresent ? "IN" : "WAIT";
    }

    function filterTable() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const rows = document.querySelectorAll('#table-body tr');
        rows.forEach(row => {
            row.classList.toggle('hidden', !row.innerText.toLowerCase().includes(query));
        });
    }

    window.onload = function() {
        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        refreshData().then(() => {
            html5QrcodeScanner.render(onScanSuccess);
            setInterval(fastSync, 3000); 
            setInterval(refreshData, 60000); 
        });
    };
</script>
