const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0QVLue4OuTPLoFIuDmhOSPJyFyN3pBpuipF2D7-HtBr_uKJqK8M3nTNvKILHWIZwdoQdLL4xmLK18/pub?gid=0&single=true&output=csv";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyW6zicDN56lKcYI3gRKrseSzsznjSC7asdMaCXNFuCFnIf_yVFJXMitl7-KEMs3WLg/exec";

    let participants = [];
    let locallyCheckedIn = new Set(); 
    let locallyReverted = new Set(); // NEW: The "Ignore List"

    async function refreshData() {
        try {
            const response = await fetch(CSV_URL + "&cb=" + Date.now());
            const data = await response.text();
            const rows = data.split(/\r?\n/).filter(row => row.trim() !== "").slice(1); 
            
            const tbody = document.getElementById('table-body');
            let presentCount = 0;
            let htmlContent = "";
            participants = [];

            rows.forEach(row => {
                const cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 3) return;

                const person = { id: cols[0], name: cols[1], combined: cols[2], status: cols[3] || "" };
                participants.push(person);

                const isPresentInSheet = person.status.toLowerCase() === "present";
                
                // REFINED LOGIC:
                // 1. If we just scanned them, they are IN.
                // 2. If we just UNDID them, they are WAIT (ignore what the sheet says for now).
                // 3. Otherwise, use what the sheet says.
                let showAsPresent = isPresentInSheet;
                
                if (locallyCheckedIn.has(person.id)) {
                    showAsPresent = true;
                }
                if (locallyReverted.has(person.id)) {
                    showAsPresent = false;
                }

                if (showAsPresent) presentCount++;

                htmlContent += `
                    <tr id="row-${person.id}" class="${showAsPresent ? 'row-present' : ''}">
                        <td>${person.id}</td>
                        <td class="name-cell">${person.name}</td>
                        <td>
                            <span class="badge" id="badge-${person.id}">${showAsPresent ? "IN" : "WAIT"}</span>
                            <button class="btn-revert" onclick="revertAttendance('${person.id}')">Undo</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = htmlContent;
            document.getElementById('count-display').innerText = presentCount;
            filterTable();
        } catch (err) { console.error("Refresh Error:", err); }
    }

    function onScanSuccess(decodedText) {
        const scanResult = decodedText.trim();
        const person = participants.find(p => p.combined === scanResult);
        if (person) {
            locallyReverted.delete(person.id); // Remove from ignore list if re-scanned
            locallyCheckedIn.add(person.id);
            updateRowUI(person.id, true);
            fetch(`${SCRIPT_URL}?id=${person.id}&action=checkin`, { method: 'GET', mode: 'no-cors' });
        }
    }

    function revertAttendance(id) {
        if (!confirm("Undo attendance for ID: " + id + "?")) return;
        
        locallyCheckedIn.delete(id); // Remove from "Scanned" list
        locallyReverted.add(id);      // Add to "Ignore Sheet" list
        
        updateRowUI(id, false);

        fetch(`${SCRIPT_URL}?id=${id}&action=revert`, { method: 'GET', mode: 'no-cors' })
            .then(() => {
                // Wait 5 seconds after the server confirms, then refresh to see if sheet caught up
                setTimeout(refreshData, 5000);
            });
    }

    function updateRowUI(id, isPresent) {
        const row = document.getElementById("row-" + id);
        const badge = document.getElementById("badge-" + id);
        if (row) row.className = isPresent ? "row-present" : "";
        if (badge) badge.innerText = isPresent ? "IN" : "WAIT";
    }

    function filterTable() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const rows = document.querySelectorAll('#table-body tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.classList.toggle('hidden', !text.includes(query));
        });
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
    refreshData().then(() => html5QrcodeScanner.render(onScanSuccess));
    setInterval(refreshData, 12000);
</script>
